<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Finance Tracker</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="styles.css">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />
<style>
 .mui {
        font-family: "Material Symbols Rounded";
        font-weight: normal;
        font-style: normal;
        font-size: 22px;
        line-height: 1;
        display: inline-block;
    }

    #hamburger { display: none; }

    @media (max-width: 1024px) {
        #hamburger {
            display: inline-flex;
            cursor: pointer;
            margin-right: auto;
            padding: 6px;
        }

        #sidebar {
            position: fixed;
            top: 0;
            left: -260px;
            height: 100%;
            width: 260px;
            background: white;
            transition: left 0.3s ease;
            z-index: 50;
        }

        #sidebar.open { left: 0; }

        #overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 40;
        }

        #overlay.show { display: block; }

        #header { position: sticky; top: 0; z-index: 100; background: white; }
    }
</style>
</head>
<body class="flex h-screen overflow-hidden bg-gray-50">

<aside id="sidebar" class="w-64 flex flex-col justify-between bg-white border-r border-gray-200 p-6 shadow-xl shadow-gray-50/50">
    <div>
        <div class="mb-10">
            <h1 class="text-2xl font-bold text-emerald-600">Finance</h1>
            <p class="text-xs text-gray-500">Personal Tracker</p>
        </div>

        <nav id="nav-links" class="space-y-2">
            <a href="dashboard.html" class="nav-link nav-item flex items-center p-3 rounded-xl">
                <span class="mui mr-3">dashboard</span> Dashboard
            </a>
            <a href="transactions.html" class="nav-link nav-item flex items-center p-3 rounded-xl">
                <span class="mui mr-3">near_me</span> Transactions
            </a>
            <a href="categories.html" class="nav-link nav-item flex items-center p-3 rounded-xl">
                <span class="mui mr-3">local_offer</span> Categories
            </a>
            <a href="analytics.html" class="nav-link nav-item flex items-center p-3 rounded-xl">
                <span class="mui mr-3">bar_chart</span> Analytics
            </a>
            <a href="settings.html" class="nav-link nav-item flex items-center p-3 rounded-xl">
                <span class="mui mr-3">settings</span> Settings
            </a>
        </nav>
    </div>

    <div class="pb-4">
        <a href="index.html" class="flex items-center text-gray-500 hover:text-red-500 transition duration-150 p-3 rounded-xl">
            <span class="mui mr-3">logout</span> Sign Out
        </a>
    </div>
</aside>

<div id="overlay"></div>

<div class="flex-1 flex flex-col overflow-y-auto">
 <header id="header" class="flex justify-end items-center bg-white p-6 border-b border-gray-200 sticky top-0 z-50">
    <div id="hamburger" class="lg:hidden">
        <span class="mui text-3xl">menu</span>
    </div>
    <div class="flex items-center space-x-4">
        <div class="text-right">
            <p class="text-sm font-medium text-gray-900" id="header-name">Loading...</p>
            <p class="text-xs text-gray-500" id="header-email">Loading...</p>
        </div>
        <div class="stat-icon bg-gray-200 text-gray-700">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
        </div>
    </div>
 </header>

<main id="main-content" class="flex-1 p-8 space-y-8">
   <h2 class="text-xl font-semibold text-gray-800">Dashboard</h2>

<div id="stat-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6">
<div class="bg-white p-6 rounded-xl shadow-lg flex justify-between items-start stat-card-total">
<div>
<p class="text-sm text-gray-500 mb-2">Total Balance</p>
<p class="text-3xl font-bold text-gray-900 stat-value">$0.00</p>
</div>
<div class="stat-icon bg-emerald-100 text-emerald-600">
<svg class="icon" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" d="M12 3v18M17 7.5c0-2.2-2.2-3.5-5-3.5s-5 1.3-5 3.5 2.2 3.5 5 3.5 5 1.3 5 3.5-2.2 3.5-5 3.5-5-1.3-5-3.5" />
</svg>
</div>
</div>
<div class="bg-white p-6 rounded-xl shadow-lg flex justify-between items-start stat-card-income">
<div>
<p class="text-sm text-gray-500 mb-2">This Month Income</p>
<p class="text-3xl font-bold text-gray-900 stat-value">$0.00</p>
</div>
<div class="stat-icon bg-green-100 text-green-600">
<svg class="icon" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5m0 0l6 6m-6-6L6 11" />
</svg>
</div>
</div>
<div class="bg-white p-6 rounded-xl shadow-lg flex justify-between items-start stat-card-expense">
<div>
<p class="text-sm text-gray-500 mb-2">This Month Expense</p>
<p class="text-3xl font-bold text-gray-900 stat-value">$0.00</p>
</div>
<div class="stat-icon bg-red-100 text-red-600">
<svg class="icon" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14m0 0l6-6m-6 6L6 13" />
</svg>
</div>
</div>
</div>

<div id="balance-trend" class="bg-white p-6 rounded-xl shadow-lg">
<h3 class="text-lg font-semibold text-gray-800 mb-4">Balance Trend</h3>
<canvas id="balance-chart" class="w-full h-80"></canvas>
</div>

<div class="bg-white p-6 rounded-xl shadow-lg">
<div class="flex justify-between items-center mb-6">
<h3 class="text-lg font-semibold text-gray-800">Recent Transactions</h3>
<a href="transactions.html" class="text-sm text-emerald-600 hover:text-emerald-700 font-medium">View All â†’</a>
</div>
<div class="space-y-4" id="recent-transactions-container"></div>
</div>
</main>
</div>

<script>
// Navigation
const sidebar = document.getElementById("sidebar");
const hamburger = document.getElementById("hamburger");
const overlay = document.getElementById("overlay");
hamburger.addEventListener("click", () => { sidebar.classList.toggle("open"); overlay.classList.toggle("show"); });
overlay.addEventListener("click", () => { sidebar.classList.remove("open"); overlay.classList.remove("show"); });

// Format currency
const formatCurrency = (num) => `$${num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

// Get current user email
const getCurrentUserEmail = () => localStorage.getItem('currentUserEmail') || '';

// Get current user data
const getCurrentUser = () => {
    const email = getCurrentUserEmail();
    if (!email) return null;
    const usersData = JSON.parse(localStorage.getItem('users') || '{}');
    return usersData[email] || null;
};

// Transactions
const getTransactions = () => {
    const user = getCurrentUser();
    if (!user || !user.transactions) return [];
    
    return user.transactions.map(t => {
        let amountValue = parseFloat(t.amount) || 0;
        if (t.type === "Expense" && amountValue > 0) amountValue = -amountValue;
        if (t.type === "Income" && amountValue < 0) amountValue = Math.abs(amountValue);
        return {...t, amount: amountValue, date: t.date};
    });
};

const calculateStats = (transactions) => {
    const income = transactions.filter(t=>t.amount>0).reduce((sum,t)=>sum+t.amount,0);
    const expense = transactions.filter(t=>t.amount<0).reduce((sum,t)=>sum+Math.abs(t.amount),0);
    const balance = income-expense;
    return { income, expense, balance };
};

const renderTransactions = (transactions) => {
    const container=document.getElementById('recent-transactions-container');
    if(!container) return;
    container.innerHTML='';
    const recent=[...transactions].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);
    if(recent.length===0){container.innerHTML='<p class="text-center text-gray-500 py-4">No recent transactions found.</p>';return;}
    recent.forEach(t=>{
        const color=t.type==='Income'?'green':'red';
        const sign=t.type==='Income'?'+':'-';
        const amountAbs=Math.abs(t.amount).toFixed(2);
        const title=t.description||"Untitled Transaction";
        const div=document.createElement('div');
        div.className='flex justify-between items-center py-3 border-b border-gray-100 last:border-b-0';
        div.innerHTML=`<div class="flex items-center space-x-4"><div class="w-2 h-2 rounded-full bg-${color}-500 flex-shrink-0"></div><div><p class="font-medium text-gray-900">${title}</p><div class="flex items-center text-xs text-gray-500 mt-0.5"><span class="px-2 py-0.5 bg-${color}-500/10 text-${color}-700 rounded font-medium mr-2">${t.category}</span><span>${t.date}</span></div></div></div><span class="font-semibold text-lg text-${color}-600">${sign}$${amountAbs}</span>`;
        container.appendChild(div);
    });
};

// Balance Trend Chart
const drawBalanceChart = (transactions) => {
    const canvas = document.getElementById('balance-chart');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const width = canvas.parentElement.clientWidth;
    const height = 320;
    canvas.width = width;
    canvas.height = height;
    ctx.clearRect(0,0,width,height);

    const today = new Date();
    const month = today.getMonth();
    const year = today.getFullYear();
    const daysInMonth = new Date(year, month+1, 0).getDate();

    const labels = [];
    const balances = [];
    let cumulative = 0;

    for(let d=1; d<=daysInMonth; d++){
        const dateObj = new Date(year, month, d);
        const dateStr = dateObj.toISOString().split('T')[0];
        labels.push(d.toString());
        const dayTransactions = transactions.filter(t=>t.date===dateStr);
        const daySum = dayTransactions.reduce((sum,t)=>sum+t.amount,0);
        cumulative += daySum;
        balances.push({value: cumulative, hasTransaction: dayTransactions.length>0});
    }

    const minVal = Math.min(...balances.map(b=>b.value),0);
    const maxVal = Math.max(...balances.map(b=>b.value),0);
    const yRange = maxVal - minVal || 1;

    const marginLeft = 50, marginBottom=30, marginTop=20, marginRight=20;
    const plotWidth = width-marginLeft-marginRight;
    const plotHeight = height-marginTop-marginBottom;

    // Axes
    ctx.strokeStyle = '#d1d5db';
    ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(marginLeft,marginTop);
    ctx.lineTo(marginLeft,height-marginBottom);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(marginLeft,height-marginBottom);
    ctx.lineTo(width-marginRight,height-marginBottom);
    ctx.stroke();

    // Y Labels
    ctx.fillStyle='#6b7280';
    ctx.font='12px sans-serif';
    ctx.textAlign='right';
    for(let i=0;i<=5;i++){
        const yVal = minVal + i*(yRange/5);
        const yPos = marginTop + plotHeight*(1-(yVal-minVal)/yRange);
        ctx.fillText(formatCurrency(yVal), marginLeft-5, yPos+3);
        ctx.strokeStyle='#e5e7eb';
        ctx.beginPath();
        ctx.moveTo(marginLeft,yPos);
        ctx.lineTo(width-marginRight,yPos);
        ctx.stroke();
    }

    // X Labels
    ctx.textAlign='center';
    const step = Math.ceil(labels.length/7);
    for(let i=0;i<labels.length;i+=step){
        const x = marginLeft + (i/(labels.length-1))*plotWidth;
        const y = height-marginBottom+15;
        ctx.fillText(labels[i], x, y);
    }

    // Line & markers
    ctx.strokeStyle = '#10b981';
    ctx.lineWidth = 3;
    ctx.beginPath();
    balances.forEach((b,i)=>{
        const x = marginLeft + (i/(balances.length-1))*plotWidth;
        const y = marginTop + plotHeight*(1-(b.value-minVal)/yRange);
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // Markers
    balances.forEach((b,i)=>{
        if(b.hasTransaction){
            const x = marginLeft + (i/(balances.length-1))*plotWidth;
            const y = marginTop + plotHeight*(1-(b.value-minVal)/yRange);
            ctx.fillStyle='#10b981';
            ctx.beginPath();
            ctx.arc(x,y,4,0,2*Math.PI);
            ctx.fill();
        }
    });
};

document.addEventListener('DOMContentLoaded',()=>{
    const user = getCurrentUser();
    if (user) {
        document.getElementById('header-name').textContent = user.name || 'User';
        document.getElementById('header-email').textContent = getCurrentUserEmail();
    }
    
    const transactions = getTransactions();
    const stats = calculateStats(transactions);
    document.querySelector('.stat-card-total .stat-value').textContent = formatCurrency(stats.balance);
    document.querySelector('.stat-card-income .stat-value').textContent = formatCurrency(stats.income);
    document.querySelector('.stat-card-expense .stat-value').textContent = formatCurrency(stats.expense);
    renderTransactions(transactions);
    drawBalanceChart(transactions);
    window.addEventListener('resize',()=>drawBalanceChart(transactions));
});
</script>
</body>
</html>
